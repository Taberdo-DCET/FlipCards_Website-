<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard | FlipCards</title>
    <link rel="stylesheet" href="flashcard.css">
    <link rel="icon" type="image/png" sizes="32x32" href="Group-100.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <header class="shop-header">
    <div class="header-left">
        <a href="lobby.html#Folderr" class="back-button">‚Üê Back to Folders</a>
        <a href="shop.html" id="upgradeBtn" class="upgrade-button" style="display: none;">Upgrade your Plan</a>
    </div>
    <h2 class="shop-title">FlipCards.</h2>
</header>

    <main class="flashcard-main-container">
        
        <div class="meta-info">
            <div class="meta-item">
                <span>Category:</span>
                <strong id="cardCategory">General</strong>
            </div>
            <div class="meta-border"></div>
            <div class="meta-item">
                <span>Creator:</span>
                <strong id="cardCreator">N/A</strong>
            </div>
        </div>

        <div class="set-details">
    <div class="title-row">
    <div class="title-and-label">
        <span class="title-label">Title:</span>
        <h1 class="page-title" id="setTitle"></h1>
    </div>
    <div class="reverse-mode-container">
    <button id="reverseInfoBtn" class="info-icon">?</button>
    <span>Reverse Mode</span>
    <label class="toggle-switch">
        <input type="checkbox" id="reverseToggle" checked="">
        <span class="slider"></span>
    </label>
</div>
</div>
    <div class="description-container">
        <div class="description-box" id="descriptionBox">Loading description...</div>
    </div>
</div>

        <div class="button-container">
            <button class="neumorphic-button active">Flashcard</button>
            <button class="neumorphic-button" onclick="goToTest()">Test</button>
            <button class="neumorphic-button" onclick="goToLearn()">Learn</button>
            <button class="neumorphic-button" onclick="goToMatch()">Match</button>
            <button class="neumorphic-button" onclick="goToDefidrop()">DefiDrop</button>
        </div>

        <div class="flashcard-container">
            <div class="flashcard">
                <div class="front"></div>
                <div class="back"></div>
            </div>
        </div>

        <div class="dot-tracker-wrapper">
            <div class="dot-tracker" id="dotTracker"></div>
        </div>
        
        <div class="navigation-controls">
            <img src="prevnc.png" alt="Previous" class="nav-btn" id="prevBtn" />
            <div id="card-counter" class="card-counter">1 / 10</div>
            <img src="nextnc.png" alt="Next" class="nav-btn" id="nextBtn" />
        </div>

        
    </main>
<div id="flipTimerModal" class="flip-timer-modal hidden">
  <div class="flip-timer-header">
    <span class="flip-timer-title">üïí FlipTimer</span>
    <span class="flip-timer-close" onclick="closeFlipTimer()">&times;</span>
  </div>
  <div class="flip-timer-body">
    <label for="studyMinutes">Study Minutes:</label>
    <input type="number" id="studyMinutes" min="1" max="180" placeholder="Enter minutes...">
    <h2 id="flipTimerLabel">Ready to Focus?</h2>
    <h1 id="flipTimerClock">00:00</h1>

    <div class="flip-timer-buttons">
      <button onclick="startFlipTimer()">Start</button>
      <button onclick="resetFlipTimer()">Reset</button>
      <button onclick="skipBreak()">Skip</button>
      <button onclick="pauseFlipTimer()" id="pauseButton">‚è∏Ô∏è Pause</button>
    </div>

    <p>Breaks Taken: <span id="breakCounter">0</span></p>
    <div style="text-align: center; margin-top: 10px;">
      <button id="collapseBtn" onclick="collapseFlipTimer()" class="neumorphic-button" style="padding: 4px 12px; font-size: 12px;">‚ñ≤ Collapse</button>
    </div>
  </div>
</div>

<!-- FlipTimer Minimized View -->
<div id="flipTimerMinimized" class="hidden" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 16px;
  border-radius: 16px;
  font-family: 'QilkaBold';
  font-size: 16px;
  z-index: 3000;
  gap: 10px;
  align-items: center;
  box-shadow: 6px 6px 12px rgba(0,0,0,0.3), -6px -6px 12px rgba(255,255,255,0.05);
  cursor: pointer;
  border: 1px solid white;
  backdrop-filter: blur(8px);
  display: flex;
">
<span id="minBreakCounter">0</span>
  <span id="flipTimerMinClock">00:00</span>
   <button onclick="expandFlipTimer()" class="neumorphic-button" style="font-size: 12px; padding: 4px 10px;">‚ñ≤ Expand</button>
</div>

<!-- Confirm Dialog -->
<div id="flipTimerConfirm" class="flip-timer-confirm hidden">
  <div class="flip-timer-confirm-box">
    <p>Want to continue?</p>
    <div>
      <button onclick="confirmFlipTimerContinue(true)">Yes</button>
      <button onclick="confirmFlipTimerContinue(false)">No</button>
    </div>
  </div>
</div>
<div id="reverseInfoModal" class="modal-overlay">
  <div class="modal-box info-modal-content">
    <i class="fa-solid fa-lightbulb modal-info-icon"></i>
    <h3>What is Reverse Mode?</h3>
    <p>Reverse Mode swaps the term and definition. You will be shown the definition first and must recall the term.</p>
    <button id="closeReverseInfoModal" class="neumorphic-button">Got it</button>
  </div>
</div>
<script src="flipTimer.js"></script>

<script type="module">
  // Import the Firebase functions we need
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
  import { db } from "./firebaseinit.js";

  const auth = getAuth();

  // --- Global variables within the module ---
  let reverseMode = true;
  let currentIndex = 0;
  let flashcards = [];
  let currentReviewingSet = null; // ‚ñº‚ñº‚ñº NEW: Variable to store the fresh data ‚ñº‚ñº‚ñº

  // --- Get references to HTML elements ---
  const front = document.querySelector(".flashcard .front");
  const back = document.querySelector(".flashcard .back");
  const card = document.querySelector(".flashcard");
  const counter = document.getElementById("card-counter");
  const reverseToggle = document.getElementById("reverseToggle");

  onAuthStateChanged(auth, async (user) => {
    if (user && !user.isAnonymous) {
      const upgradeBtn = document.getElementById('upgradeBtn');
      const userRolesRef = doc(db, "approved_emails", user.email);
      const userRolesSnap = await getDoc(userRolesRef);

      if (userRolesSnap.exists()) {
        const roles = userRolesSnap.data().role.toLowerCase();
        if (!roles.includes('plus') && !roles.includes('verified')) {
          upgradeBtn.style.display = 'inline-block';
        }
      }
    }

    const reviewingSetId = localStorage.getItem("reviewingSetId");
    const collectionName = localStorage.getItem("reviewingSetCollection");

    if (!reviewingSetId || !collectionName) {
      document.body.innerHTML = "<h2 style='color:white; text-align:center; padding-top:100px;'>Error: No flashcard set ID found.</h2>";
      return;
    }

    try {
      const setRef = doc(db, collectionName, reviewingSetId);
      const docSnap = await getDoc(setRef);

      if (docSnap.exists()) {
        const reviewingSetData = docSnap.data();
        currentReviewingSet = reviewingSetData; // ‚ñº‚ñº‚ñº NEW: Save fresh data to our variable ‚ñº‚ñº‚ñº
        flashcards = reviewingSetData.flashcards || [];

        document.getElementById("setTitle").textContent = reviewingSetData.title || "Untitled Set";
        document.getElementById("descriptionBox").textContent = reviewingSetData.description || "No description provided.";
        document.getElementById("cardCategory").textContent = reviewingSetData.category || "General";
        
        const creatorEmail = reviewingSetData.creatorEmail || reviewingSetData.user;
        if (creatorEmail) {
          const usernameRef = doc(db, "usernames", creatorEmail);
          const usernameSnap = await getDoc(usernameRef);
          if (usernameSnap.exists() && usernameSnap.data().username) {
            document.getElementById("cardCreator").textContent = usernameSnap.data().username;
          } else {
            document.getElementById("cardCreator").textContent = creatorEmail.split('@')[0];
          }
        } else {
          document.getElementById("cardCreator").textContent = "N/A";
        }

        if (flashcards.length > 0) {
          setupDotTracker(flashcards.length);
          updateCard(currentIndex);
        } else {
          front.textContent = "This set is empty.";
          back.textContent = "Add some cards!";
        }
      } else {
         document.body.innerHTML = "<h2 style='color:white; text-align:center; padding-top:100px;'>Error: Could not find this flashcard set.</h2>";
      }
    } catch (error) {
      console.error("Error fetching flashcard set:", error);
      document.body.innerHTML = "<h2 style='color:white; text-align:center; padding-top:100px;'>An error occurred while loading the set.</h2>";
    }
  });

  // --- Helper Functions ---
  function isImageUrl(text) { return typeof text === "string" && text.startsWith("https://") && text.includes("firebasestorage.googleapis.com"); }
  function updateCard(index) {
    card.style.transition = "none";
    card.classList.remove("flipped");
    const cardData = flashcards[index];
    if (!cardData) return;
    if (!reverseMode) {
      front.textContent = cardData.term;
      if (isImageUrl(cardData.definition)) { back.innerHTML = `<img src="${cardData.definition}" alt="Definition Image" style="max-width:100%; max-height:100%; border-radius: 8px;" />`; } else { back.textContent = cardData.definition; }
    } else {
      if (isImageUrl(cardData.definition)) { front.innerHTML = `<img src="${cardData.definition}" alt="Definition Image" style="max-width:100%; max-height:100%; border-radius: 8px;" />`; } else { front.textContent = cardData.definition; }
      back.textContent = cardData.term;
    }
    counter.textContent = `${index + 1} / ${flashcards.length}`;
    updateDotTracker(index, flashcards.length);
    setTimeout(() => { card.style.transition = "transform 0.8s"; }, 10);
  }
  function setupDotTracker(total) {
    const container = document.getElementById("dotTracker");
    container.innerHTML = "";
    for (let i = 0; i < total; i++) {
      const dot = document.createElement("div");
      dot.classList.add("dot");
      container.appendChild(dot);
    }
  }
  function updateDotTracker(currentIndex, total, maxVisible = 6) {
    const container = document.getElementById("dotTracker");
    const dots = container.querySelectorAll(".dot");
    dots.forEach((dot, i) => dot.classList.toggle("active", i === currentIndex));
    let start = Math.max(0, currentIndex - Math.floor(maxVisible / 2));
    start = Math.min(start, Math.max(0, total - maxVisible));
    const offset = start * (12 + 10);
    container.style.transform = `translateX(-${offset}px)`;
  }

  // --- Event Listeners ---
  reverseToggle.addEventListener("change", (event) => { reverseMode = event.target.checked; updateCard(currentIndex); });
  document.getElementById("prevBtn").addEventListener("click", () => { if (currentIndex > 0) { currentIndex--; updateCard(currentIndex); } });
  document.getElementById("nextBtn").addEventListener("click", () => { if (currentIndex < flashcards.length - 1) { currentIndex++; updateCard(currentIndex); } });
  card.addEventListener("click", () => { card.classList.toggle("flipped"); });
  document.addEventListener("keydown", (e) => {
    if (document.activeElement.tagName !== "INPUT") {
      if (e.key === "ArrowRight") { document.getElementById("nextBtn").click(); } 
      else if (e.key === "ArrowLeft") { document.getElementById("prevBtn").click(); }
    }
  });

  // --- ‚ñº‚ñº‚ñº UPDATED: Functions for Mode Buttons ‚ñº‚ñº‚ñº ---
  function navigateToMode(modeUrl) {
    if (currentReviewingSet) {
      localStorage.setItem("reviewingSet", JSON.stringify(currentReviewingSet));
    }
    localStorage.setItem("currentIndex", currentIndex);
    window.location.href = modeUrl;
  }

  window.goToTest = function() { navigateToMode("test.html"); }
  window.goToMatch = function() { navigateToMode("match.html"); }
  window.goToDefidrop = function() { navigateToMode("defidrop.html"); }
  window.goToLearn = function() { navigateToMode("learn.html"); }
</script>
<script type="module">
  import { checkUserStatus } from './userstatuscheck.js';
  checkUserStatus();
</script>
<script type="module" src="presence.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const infoBtn = document.getElementById('reverseInfoBtn');
    const infoModal = document.getElementById('reverseInfoModal');
    const closeInfoModalBtn = document.getElementById('closeReverseInfoModal');

    infoBtn.addEventListener('click', () => {
      infoModal.classList.add('visible');
    });

    closeInfoModalBtn.addEventListener('click', () => {
      infoModal.classList.remove('visible');
    });

    // Also close if the user clicks the dark background
    infoModal.addEventListener('click', (event) => {
      if (event.target === infoModal) {
        infoModal.classList.remove('visible');
      }
    });
  });
</script>
<script src="protect.js"></script>
</body>
</html>
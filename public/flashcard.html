<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard | FlipCards</title>
    <link rel="stylesheet" href="flashcard.css">
    <link rel="icon" type="image/png" sizes="32x32" href="Group-100.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4779578721359852"
     crossorigin="anonymous"></script>
</head>
<body>
    <header class="shop-header">
    <div class="header-left">
        <a href="#" id="backToFoldersBtn" class="back-button">‚Üê Back to Folders</a>
        <a href="shop.html" id="upgradeBtn" class="upgrade-button" style="display: none;">Upgrade your Plan</a>
    </div>
    <h2 class="shop-title">FlipCards.</h2>
</header>

    <main class="flashcard-main-container">
        <div id="feedbackText" class="floating-text"></div>
        <div class="meta-info">
            <div class="meta-item">
                <span>Category:</span>
                <strong id="cardCategory">General</strong>
            </div>
            <div class="meta-border"></div>
            <div class="meta-item">
                <span>Creator:</span>
                <strong id="cardCreator">N/A</strong>
            </div>
        </div>

        <div class="set-details">
    <div class="title-row">
    <div class="title-and-label">
        <span class="title-label">Title:</span>
        <h1 class="page-title" id="setTitle"></h1>
    </div>
    <div class="reverse-mode-container">
    <button id="reverseInfoBtn" class="info-icon">?</button>
    <span>Reverse Mode</span>
    <label class="toggle-switch">
        <input type="checkbox" id="reverseToggle" checked="">
        <span class="slider"></span>
    </label>
</div>
</div>
    <div class="description-container">
    <div class="description-box" id="descriptionBox">Loading description...</div>
</div>

<button id="exitReviewBtn" class="neumorphic-button exit-review-btn hidden">
    Exit Review Session
</button>
</div>

        <div class="button-container">
    <button class="neumorphic-button active" onclick="navigateToMode('flashcard.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>Flashcard</button>
    <button class="neumorphic-button" onclick="navigateToMode('test.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10.4 12.6-2.8 2.8"></path><path d="m10.4 15.4-2.8-2.8"></path><path d="M12 18h6"></path></svg>

Test</button>
    <button id="blitzButton" class="neumorphic-button" onclick="navigateToMode('blitz.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
</svg>
    Blitz
    <img src="new.png" alt="New Feature" class="new-icon">
</button>
    <button class="neumorphic-button" onclick="navigateToMode('learn.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.232 5.232a3 3 0 0 1 0 4.242L12 12.728l-3.232-3.232a3 3 0 0 1 0-4.242a3 3 0 0 1 4.242 0z"></path><path d="M12 12.728 8.768 9.496a3 3 0 0 1 0 4.242L12 17.228l3.232-3.232a3 3 0 0 1 0-4.242z"></path></svg>

Learn</button>
    <button class="neumorphic-button" onclick="navigateToMode('match.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 7h-4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path><path d="M10 7V5.5a1.5 1.5 0 0 1 3 0V7"></path><path d="M14 17v1.5a1.5 1.5 0 0 1-3 0V17"></path><path d="M7 10H5.5a1.5 1.5 0 0 0 0 3H7"></path><path d="M17 14h1.5a1.5 1.5 0 0 0 0-3H17"></path></svg>
Match</button>
    <button class="neumorphic-button" onclick="navigateToMode('defidrop.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="m19 12-7-7"></path></svg>DefiDrop</button>
</div>

        <div class="flashcard-container">
            <div class="flashcard">
                <div class="front"></div>
                <div class="back"></div>
            </div>
        </div>

        
        
<div class="navigation-controls">
    <div class="performance-monitor-container">
    <span>Monitor performance</span>
    <label class="toggle-switch">
        <input type="checkbox" id="performanceToggle">
        <span class="slider"></span>
    </label>
    <span id="reviewCounter" class="review-counter">0</span>
</div>

    <div class="nav-btn" id="prevBtn">
        <i class="fa-solid fa-chevron-left"></i>
    </div>
<div class="nav-btn" id="nextBtn">
        <i class="fa-solid fa-chevron-right"></i>
    </div>
    <div id="card-counter" class="card-counter">1 / 10</div>


</div>

        
    </main>
<div id="flipTimerModal" class="flip-timer-modal hidden">
  <div class="flip-timer-header">
    <span class="flip-timer-title">üïí FlipTimer</span>
    <span class="flip-timer-close" onclick="closeFlipTimer()">&times;</span>
  </div>
  <div class="flip-timer-body">
    <label for="studyMinutes">Study Minutes:</label>
    <input type="number" id="studyMinutes" min="1" max="180" placeholder="Enter minutes...">
    <h2 id="flipTimerLabel">Ready to Focus?</h2>
    <h1 id="flipTimerClock">00:00</h1>

    <div class="flip-timer-buttons">
      <button onclick="startFlipTimer()">Start</button>
      <button onclick="resetFlipTimer()">Reset</button>
      <button onclick="skipBreak()">Skip</button>
      <button onclick="pauseFlipTimer()" id="pauseButton">‚è∏Ô∏è Pause</button>
    </div>

    <p>Breaks Taken: <span id="breakCounter">0</span></p>
    <div style="text-align: center; margin-top: 10px;">
      <button id="collapseBtn" onclick="collapseFlipTimer()" class="neumorphic-button" style="padding: 4px 12px; font-size: 12px;">‚ñ≤ Collapse</button>
    </div>
  </div>
</div>

<!-- FlipTimer Minimized View -->
<div id="flipTimerMinimized" class="hidden" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 16px;
  border-radius: 16px;
  font-family: 'QilkaBold';
  font-size: 16px;
  z-index: 3000;
  gap: 10px;
  align-items: center;
  box-shadow: 6px 6px 12px rgba(0,0,0,0.3), -6px -6px 12px rgba(255,255,255,0.05);
  cursor: pointer;
  border: 1px solid white;
  backdrop-filter: blur(8px);
  display: flex;
">
<span id="minBreakCounter">0</span>
  <span id="flipTimerMinClock">00:00</span>
   <button onclick="expandFlipTimer()" class="neumorphic-button" style="font-size: 12px; padding: 4px 10px;">‚ñ≤ Expand</button>
</div>

<!-- Confirm Dialog -->
<div id="flipTimerConfirm" class="flip-timer-confirm hidden">
  <div class="flip-timer-confirm-box">
    <p>Want to continue?</p>
    <div>
      <button onclick="confirmFlipTimerContinue(true)">Yes</button>
      <button onclick="confirmFlipTimerContinue(false)">No</button>
    </div>
  </div>
</div>
<div id="reverseInfoModal" class="modal-overlay">
  <div class="modal-box info-modal-content">
    <i class="fa-solid fa-lightbulb modal-info-icon"></i>
    <h3>What is Reverse Mode?</h3>
    <p>Reverse Mode swaps the term and definition. You will be shown the definition first and must recall the term.</p>
    <button id="closeReverseInfoModal" class="neumorphic-button">Got it</button>
  </div>
</div>
<div id="toggleSidenavBtn" class="sidenav-toggle-btn">
    <i class="fa-solid fa-chevron-right"></i>
</div>

<div id="reviewSidenav" class="sidenav">
    <h3>Cards for Review</h3>
    <div class="sidenav-buttons">
        <button id="reviewBtn" class="sidenav-btn review">
            <i class="fa-solid fa-star"></i> Review
        </button>
        <button id="resetReviewBtn" class="sidenav-btn reset">
            <i class="fa-solid fa-trash"></i> Reset
        </button>
    </div>
    <div id="reviewCardsList">
        <p>Loading review cards...</p>
    </div>
</div>
<div id="customConfirmModal" class="custom-alert-backdrop hidden">
  <div class="custom-alert-content error">
    <p id="confirmMessage"></p>
    <div class="modal-buttons">
      <button id="confirmBtn" class="neumorphic-button">Confirm</button>
      <button id="cancelBtn" class="neumorphic-button">Cancel</button>
    </div>
  </div>
</div>
<div id="customAlertModal" class="custom-alert-backdrop hidden">
  <div class="custom-alert-content">
    <p id="customAlertMessage"></p>
    <button id="customAlertOkBtn" class="neumorphic-button">OK</button>
</div>
<script src="flipTimer.js"></script>

<script type="module">
  // Import the Firebase functions we need
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
  import { db } from "./firebaseinit.js";

  const auth = getAuth();

  // --- Global variables within the module ---
  let reverseMode = true;
  let currentIndex = 0;
  let flashcards = [];
  let currentReviewingSet = null; // ‚ñº‚ñº‚ñº NEW: Variable to store the fresh data ‚ñº‚ñº‚ñº
  let originalSetData = null; // To store the original set before review
const exitReviewBtn = document.getElementById('exitReviewBtn');

  // --- Get references to HTML elements ---
  const front = document.querySelector(".flashcard .front");
  const back = document.querySelector(".flashcard .back");
  const card = document.querySelector(".flashcard");
  const counter = document.getElementById("card-counter");
  const reverseToggle = document.getElementById("reverseToggle");
  const backToFoldersBtn = document.getElementById("backToFoldersBtn");
  const feedbackText = document.getElementById('feedbackText');
  const reviewCounter = document.getElementById('reviewCounter');

  onAuthStateChanged(auth, async (user) => {
    if (user && !user.isAnonymous) {
      const upgradeBtn = document.getElementById('upgradeBtn');
      const userRolesRef = doc(db, "approved_emails", user.email);
      const userRolesSnap = await getDoc(userRolesRef);

      if (userRolesSnap.exists()) {
        const roles = userRolesSnap.data().role.toLowerCase();
        if (!roles.includes('plus') && !roles.includes('verified')) {
          upgradeBtn.style.display = 'inline-block';
        }
      }
    }

    const reviewingSetId = localStorage.getItem("reviewingSetId");
    const collectionName = localStorage.getItem("reviewingSetCollection");

    if (!reviewingSetId || !collectionName) {
      document.body.innerHTML = "<h2 style='color:white; text-align:center; padding-top:100px;'>Error: No flashcard set ID found.</h2>";
      return;
    }

    try {
      const setRef = doc(db, collectionName, reviewingSetId);
      const docSnap = await getDoc(setRef);

      if (docSnap.exists()) {
    const reviewingSetData = docSnap.data();

    // ‚ñº‚ñº‚ñº NEW: Store the original set data when the page first loads ‚ñº‚ñº‚ñº
    originalSetData = {
        flashcards: reviewingSetData.flashcards || [],
        title: reviewingSetData.title || "Untitled Set",
        description: reviewingSetData.description || "No description provided.",
        category: reviewingSetData.category || "General",
        creatorEmail: reviewingSetData.creatorEmail || reviewingSetData.user
    };
    // ‚ñ≤‚ñ≤‚ñ≤ END OF ADDITION ‚ñ≤‚ñ≤‚ñ≤

    currentReviewingSet = reviewingSetData;
    flashcards = reviewingSetData.flashcards || [];

        document.getElementById("setTitle").textContent = reviewingSetData.title || "Untitled Set";
        document.getElementById("descriptionBox").textContent = reviewingSetData.description || "No description provided.";
        document.getElementById("cardCategory").textContent = reviewingSetData.category || "General";
        
        const creatorEmail = reviewingSetData.creatorEmail || reviewingSetData.user;
        if (creatorEmail) {
          const usernameRef = doc(db, "usernames", creatorEmail);
          const usernameSnap = await getDoc(usernameRef);
          if (usernameSnap.exists() && usernameSnap.data().username) {
  const creatorName = usernameSnap.data().username;
  document.getElementById("cardCreator").textContent = creatorName;
  originalSetData.creatorName = creatorName; // --- ADD THIS LINE ---
} else {
  document.getElementById("cardCreator").textContent = creatorEmail.split('@')[0];
}
        } else {
          document.getElementById("cardCreator").textContent = "N/A";
        }

        if (flashcards.length > 0) {
          
          updateCard(currentIndex);
        } else {
          front.textContent = "This set is empty.";
          back.textContent = "Add some cards!";
        }fetchAndDisplayReviewCards();
      } else {
         document.body.innerHTML = "<h2 style='color:white; text-align:center; padding-top:100px;'>Error: Could not find this flashcard set.</h2>";
      }
    } catch (error) {
      console.error("Error fetching flashcard set:", error);
      document.body.innerHTML = "<h2 style='color:white; text-align:center; padding-top:100px;'>An error occurred while loading the set.</h2>";
    }
  });

  // --- Helper Functions ---
  function isImageUrl(text) { return typeof text === "string" && text.startsWith("https://") && text.includes("firebasestorage.googleapis.com"); }
  function updateCard(index) {
    card.style.transition = "none";
    card.classList.remove("flipped");
    const cardData = flashcards[index];
    if (!cardData) return;
    if (!reverseMode) {
      front.textContent = cardData.term;
      if (isImageUrl(cardData.definition)) { back.innerHTML = `<img src="${cardData.definition}" alt="Definition Image" style="max-width:100%; max-height:100%; border-radius: 8px;" />`; } else { back.textContent = cardData.definition; }
    } else {
      if (isImageUrl(cardData.definition)) { front.innerHTML = `<img src="${cardData.definition}" alt="Definition Image" style="max-width:100%; max-height:100%; border-radius: 8px;" />`; } else { front.textContent = cardData.definition; }
      back.textContent = cardData.term;
    }
    counter.textContent = `${index + 1} / ${flashcards.length}`;
    
    setTimeout(() => { card.style.transition = "transform 0.3s"; }, 10);
  }
function showFeedback(type) {
    // Don't show feedback if we're in the locked "My Review Session" mode
    if (performanceToggle.disabled) return;

    if (type === 'sad') {
        feedbackText.textContent = "+1 Card for Review";
        feedbackText.className = 'floating-text sad animate';
    } else if (type === 'happy') {
        feedbackText.textContent = "‚úîÔ∏è Marked as Known";
        feedbackText.className = 'floating-text happy animate';
    }

    // Reset the animation class after it finishes
    setTimeout(() => {
        feedbackText.className = 'floating-text';
    }, 1200); // This duration must match the animation time in the CSS
}
  // --- Event Listeners ---
reverseToggle.addEventListener("change", (event) => { reverseMode = event.target.checked; updateCard(currentIndex); });
card.addEventListener("click", () => { card.classList.toggle("flipped"); });

// --- Helper function to advance to the next card ---
function handleNextCard() {
    if (currentIndex < flashcards.length - 1) {
        currentIndex++;
        updateCard(currentIndex);
    }
}

// --- Helper function to save a card to Firestore for review ---
// --- Helper function to save a card to Firestore for review ---
async function recordCardForReview() {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) {
        console.log("Anonymous or logged-out user. Cannot save card for review.");
        return;
    }

    const cardToReview = flashcards[currentIndex];
    if (!cardToReview) {
        console.error("Could not find card data to save.");
        return;
    }

    const isAlreadyInReview = localReviewCards.some(
        (card) => card.term === cardToReview.term && card.definition === cardToReview.definition
    );

    if (isAlreadyInReview) {
        console.log("This card is already in the review list. Skipping.");
        return;
    }

    const userEmail = user.email;
    const reviewRef = doc(db, "flashcardreview", userEmail);

    try {
        const newCardData = {
            term: cardToReview.term,
            definition: cardToReview.definition,
            fromSetId: localStorage.getItem("reviewingSetId"),
            fromSetTitle: document.getElementById("setTitle").textContent
        };

        // Now we ONLY update Firestore. The real-time listener will handle all UI and local array updates.
        await setDoc(reviewRef, {
            cardsForReview: arrayUnion(newCardData)
        }, { merge: true });

    } catch (error) {
        console.error("Error saving card for review:", error);
    }
}

// --- Helper function to REMOVE a card from the Firestore review list ---
async function removeCardFromReview() {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) return; // Exit if no user

    const cardToRemove = flashcards[currentIndex];
    if (!cardToRemove) return; // Exit if there's no card data

    const reviewRef = doc(db, "flashcardreview", user.email);

    try {
        // Use updateDoc and arrayRemove to pull the specific card object from the array
        await updateDoc(reviewRef, {
            cardsForReview: arrayRemove(cardToRemove)
        });
    } catch (error) {
        console.error("Error removing card from review:", error);
    }
}

const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");

prevBtn.addEventListener("click", async () => {
    if (performanceToggle.checked) {
      showFeedback('sad');
        // PERFORMANCE MODE: The sad face was clicked ("I didn't know this card")
        // 1. Record the current card to Firestore.
        await recordCardForReview();
        // 2. Proceed to the next card.
        handleNextCard();
    } else {
        // NORMAL MODE: This is the "previous" button.
        if (currentIndex > 0) {
            currentIndex--;
            updateCard(currentIndex);
        }
    }
});

nextBtn.addEventListener('click', async () => {
    if (performanceToggle.disabled) {
        // --- This is the "My Review Session" mode logic ---
        // (No changes needed here)
        if (flashcards.length > 0 && currentIndex < flashcards.length) {
            await removeCardFromReview();
        }
        if (currentIndex >= flashcards.length && flashcards.length > 0) {
            currentIndex = flashcards.length - 1;
        }
        if (flashcards.length === 0) {
            front.textContent = "Review Complete!";
            back.textContent = "You've mastered all your review cards.";
            counter.textContent = "0 / 0";
        } else {
            updateCard(currentIndex);
        }
    } else {
        // --- This is the NORMAL mode logic ---
        if (performanceToggle.checked) {
            showFeedback('happy'); // Show happy feedback
        }
        handleNextCard(); // Always go to the next card
    }
});

document.addEventListener("keydown", (e) => {
  if (document.activeElement.tagName !== "INPUT") {
    if (e.key === "ArrowRight") { nextBtn.click(); } 
    else if (e.key === "ArrowLeft") { prevBtn.click(); }
  }
});
// --- New Performance Monitor Logic ---
const performanceToggle = document.getElementById('performanceToggle');
const prevIcon = document.querySelector('#prevBtn i');
const nextIcon = document.querySelector('#nextBtn i');

performanceToggle.addEventListener('change', (event) => {
    const isPerformanceMode = event.target.checked;

    if (isPerformanceMode) {
        prevIcon.className = 'fa-regular fa-face-frown';
        nextIcon.className = 'fa-regular fa-face-smile';
        reviewCounter.classList.add('visible'); // --- THIS LINE IS NEW ---
    } else {
        prevIcon.className = 'fa-solid fa-chevron-left';
        nextIcon.className = 'fa-solid fa-chevron-right';
        reviewCounter.classList.remove('visible'); // --- THIS LINE IS NEW ---
    }
});
// --- Review Sidenav Logic ---
const toggleSidenavBtn = document.getElementById('toggleSidenavBtn');
const reviewSidenav = document.getElementById('reviewSidenav');
const reviewCardsList = document.getElementById('reviewCardsList');
const toggleIcon = document.querySelector('#toggleSidenavBtn i');
const reviewBtn = document.getElementById('reviewBtn');
const resetReviewBtn = document.getElementById('resetReviewBtn');
let reviewDataLoaded = false;
let localReviewCards = []; // To store a local copy of review cards
// Single function to toggle the navigation panel
function toggleNav() {
    const currentWidth = reviewSidenav.style.width;
    if (currentWidth === "350px") {
        // If it's open, close it
        reviewSidenav.style.width = "0";
        toggleSidenavBtn.style.left = "0";
        toggleIcon.style.transform = "rotate(0deg)";
    } else {
        // If it's closed, open it
        reviewSidenav.style.width = "350px";
        toggleSidenavBtn.style.left = "350px";
        toggleIcon.style.transform = "rotate(180deg)";
    }
}

// Function to fetch and display cards from the 'flashcardreview' collection
// Function to fetch and display cards from the 'flashcardreview' collection
// This function now sets up a REAL-TIME listener for review cards
function fetchAndDisplayReviewCards() {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) {
        reviewCardsList.innerHTML = "<p>Please log in to see your review list.</p>";
        return;
    }

    const reviewRef = doc(db, "flashcardreview", user.email);

    // Use onSnapshot to listen for real-time changes
    // Use onSnapshot to listen for real-time changes
onSnapshot(reviewRef, (docSnap) => {
    const cards = (docSnap.exists() && docSnap.data().cardsForReview) ? docSnap.data().cardsForReview : [];
    localReviewCards = cards;

    reviewCounter.textContent = `${cards.length}`; // --- THIS LINE IS NEW ---

    if (performanceToggle.disabled) {
        flashcards = cards;
    }

    if (cards.length > 0) {
        reviewCardsList.innerHTML = "";
        cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'review-card-item';
            cardElement.innerHTML = `
                <p class="term">${card.term}</p>
                <p class="definition">${card.definition}</p>
            `;
            reviewCardsList.appendChild(cardElement);
        });
    } else {
        reviewCardsList.innerHTML = "<p>You haven't marked any cards for review yet.</p>";
    }
}, (error) => {
    console.error("Error with real-time listener:", error);
    reviewCardsList.innerHTML = "<p>Sorry, there was an error loading your review cards.</p>";
});
    reviewDataLoaded = true; // Mark the listener as attached
}
// Attach a single event listener to the toggle button
toggleSidenavBtn.addEventListener('click', toggleNav);
// --- Event listener for the "Reset" button ---
// --- Event listener for the "Reset" button ---
resetReviewBtn.addEventListener('click', () => {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) {
        alert("You must be logged in to reset your review list.");
        return;
    }

    showCustomConfirm("Are you sure you want to clear all cards from your review list? This cannot be undone.", async () => {
        const reviewRef = doc(db, "flashcardreview", user.email);
        try {
            // Now we ONLY update Firestore. The real-time listener will handle the UI.
            await setDoc(reviewRef, { cardsForReview: [] }, { merge: true });
        } catch (error) {
            console.error("Error clearing review list:", error);
            alert("There was an error clearing your list.");
        }
    });
});

// --- NEW: Helper function to manage the custom confirmation modal ---
function showCustomConfirm(message, onConfirm) {
    const confirmModal = document.getElementById('customConfirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmBtn = document.getElementById('confirmBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    confirmMessage.textContent = message;
    confirmModal.classList.remove('hidden');

    // Create one-time event listeners to prevent duplicates
    const confirmHandler = () => {
        onConfirm();
        closeHandler();
    };

    const closeHandler = () => {
        confirmModal.classList.add('hidden');
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', closeHandler);
    };

    confirmBtn.addEventListener('click', confirmHandler);
    cancelBtn.addEventListener('click', closeHandler);
}
// --- NEW: Helper function to manage a simple custom alert modal ---
function showCustomAlert(message) {
    const alertModal = document.getElementById('customAlertModal');
    const alertMessage = document.getElementById('customAlertMessage');
    const alertOkBtn = document.getElementById('customAlertOkBtn');

    alertMessage.textContent = message;
    alertModal.classList.remove('hidden');

    const closeHandler = () => {
        alertModal.classList.add('hidden');
        alertOkBtn.removeEventListener('click', closeHandler);
    };

    alertOkBtn.addEventListener('click', closeHandler);
}
// --- Event listener for the "Review" button ---
// --- Event listener for the "Review" button ---
// --- Event listener for the "Review" button ---
reviewBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user || user.isAnonymous) {
        showCustomAlert("You must be logged in to review your cards.");
        return;
    }

    const reviewRef = doc(db, "flashcardreview", user.email);
    const docSnap = await getDoc(reviewRef);

    if (docSnap.exists() && docSnap.data().cardsForReview && docSnap.data().cardsForReview.length > 0) {
        const reviewCards = docSnap.data().cardsForReview;

        flashcards = reviewCards; 
        currentIndex = 0; 

        updateCard(currentIndex); 
        document.getElementById("setTitle").textContent = "My Review Session";
        document.getElementById("descriptionBox").textContent = "Reviewing cards you found difficult.";
        document.getElementById("cardCategory").textContent = "Review";
        // --- ‚ñº‚ñº‚ñº ADD THIS LINE FOR DEBUGGING ‚ñº‚ñº‚ñº ---
        console.log("Entering Review Mode. Current user object:", user);
        // --- ‚ñ≤‚ñ≤‚ñ≤ END OF ADDED LINE ‚ñ≤‚ñ≤‚ñ≤ ---
        // Set creator to the current user's username
const usernameRef = doc(db, "usernames", user.email);
const usernameSnap = await getDoc(usernameRef);
if (usernameSnap.exists() && usernameSnap.data().username) {
    document.getElementById("cardCreator").textContent = usernameSnap.data().username;
} else {
    // Fallback to email if no username is found
    document.getElementById("cardCreator").textContent = user.email.split('@')[0];
}

        // --- ADD THESE LINES ---
        performanceToggle.checked = true; // Turn the toggle on
        performanceToggle.dispatchEvent(new Event('change')); // Trigger the icon change
        performanceToggle.disabled = true; // Disable the toggle
        // --- END OF ADDED LINES ---
exitReviewBtn.classList.remove('hidden'); // Show the exit button
        toggleNav();

    } else {
        showCustomAlert("You have no cards in your review list to study!");
    }
});
// --- New Event Listener for Back to Folders Button ---
// --- New Event Listener for Back to Folders Button ---
backToFoldersBtn.addEventListener('click', async (event) => {
    event.preventDefault(); // Prevent the link from navigating immediately

    const user = auth.currentUser;
    if (user && !user.isAnonymous) {
        const userEmail = user.email;
        const reviewRef = doc(db, "flashcardreview", userEmail);

        try {
            await setDoc(reviewRef, { cardsForReview: [] }, { merge: true });
        } catch (error) {
            console.error("Error clearing the review collection:", error);
        }
    }

    // --- ADD THIS LINE ---
    // Re-enable the toggle before leaving the page
    performanceToggle.disabled = false; 
    // --- END OF ADDED LINE ---

    // Navigate to the lobby after the operation is complete
    window.location.href = "lobby.html#Folderr";
});
// --- Event Listener for Exiting Review Mode ---
// --- Event Listener for Exiting Review Mode ---
exitReviewBtn.addEventListener('click', () => {
    // Show the custom confirmation modal first
    showCustomConfirm(
        "Exiting will clear all cards from your review list. Are you sure?",
        async () => {
            // This code runs only after the user clicks "Confirm"
            const user = auth.currentUser;
            if (user && !user.isAnonymous) {
                const reviewRef = doc(db, "flashcardreview", user.email);
                try {
                    // Clear the review list in Firestore
                    await setDoc(reviewRef, { cardsForReview: [] }, { merge: true });
                } catch (error) {
                    console.error("Error clearing review list on exit:", error);
                    // Optionally show an error alert to the user
                }
            }

            if (!originalSetData) return; // Safety check

            // 1. Restore the original flashcard data
            flashcards = originalSetData.flashcards;
            currentIndex = 0;

            // 2. Update the UI with original data
            updateCard(currentIndex);
            document.getElementById("setTitle").textContent = originalSetData.title;
            document.getElementById("descriptionBox").textContent = originalSetData.description;
            document.getElementById("cardCategory").textContent = originalSetData.category;
            document.getElementById("cardCreator").textContent = originalSetData.creatorName || originalSetData.creatorEmail.split('@')[0];

            // 3. Reset and re-enable the performance toggle
            performanceToggle.checked = false;
            performanceToggle.dispatchEvent(new Event('change'));
            performanceToggle.disabled = false;

            // 4. Hide the "Exit Review Session" button
            exitReviewBtn.classList.add('hidden');
        }
    );
});
  async function navigateToMode(modeUrl) {
  // --- ADD THIS BLOCK TO CLEAR THE REVIEW LIST ---
  const user = auth.currentUser;
  if (user && !user.isAnonymous) {
      const userEmail = user.email;
      const reviewRef = doc(db, "flashcardreview", userEmail);
      try {
          // Set the 'cardsForReview' array to be empty
          await setDoc(reviewRef, { cardsForReview: [] }, { merge: true });
      } catch (error) {
          console.error("Error clearing the review collection:", error);
      }
  }
  // --- END OF ADDED BLOCK ---

  if (currentReviewingSet) {
    localStorage.setItem("reviewingSet", JSON.stringify(currentReviewingSet));
  }
  localStorage.setItem("currentIndex", currentIndex);
  window.location.href = modeUrl;
}
window.navigateToMode = navigateToMode;
  
</script>
<script type="module">
  import { checkUserStatus } from './userstatuscheck.js';
  checkUserStatus();
</script>
<script type="module" src="presence.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const infoBtn = document.getElementById('reverseInfoBtn');
    const infoModal = document.getElementById('reverseInfoModal');
    const closeInfoModalBtn = document.getElementById('closeReverseInfoModal');

    infoBtn.addEventListener('click', () => {
      infoModal.classList.add('visible');
    });

    closeInfoModalBtn.addEventListener('click', () => {
      infoModal.classList.remove('visible');
    });

    // Also close if the user clicks the dark background
    infoModal.addEventListener('click', (event) => {
      if (event.target === infoModal) {
        infoModal.classList.remove('visible');
      }
    });
  });
</script>
<script src="protect.js"></script>
</body>
</html>
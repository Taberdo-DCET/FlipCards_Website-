<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Learn | FlipCards</title>
  <link rel="stylesheet" href="learn.css" />
  <link rel="icon" type="image/png" sizes="32x32" href="Group-100.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4779578721359852"
     crossorigin="anonymous"></script>
</head>
<body>
  <div class="card-set-container">
    <header class="shop-header">
        <div class="header-left">
            <a href="lobby.html#Folderr" class="back-button">‚Üê Back to Folders</a>
            <a href="shop.html" id="upgradeBtn" class="upgrade-button" style="display: none;">Upgrade your Plan</a>
        </div>
        <h2 class="shop-title">FlipCards.</h2>
    </header>
<div id="toggleMistakesSidenavBtn" class="sidenav-toggle-btn right">
        <i class="fa-solid fa-exclamation-triangle"></i>
    </div>
    <main class="learn-main-container">
        
        <div class="meta-info">
            <div class="meta-item">
                <span>Category:</span>
                <strong id="cardCategory">General</strong>
            </div>
            <div class="meta-border"></div>
            <div class="meta-item">
                <span>Creator:</span>
                <strong id="cardCreator">N/A</strong>
            </div>
        </div>

        <div class="set-details">
            <div class="title-row">
                <div class="title-and-label">
                    <span class="title-label">Title:</span>
                    <h1 class="page-title" id="learnSetTitle"></h1>
                </div>
            </div>
            
            <div class="reverse-mode-container">
                <button id="reverseInfoBtn" class="info-icon">?</button>
                <span>Reverse Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="reverseToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="description-container">
                <div class="description-box" id="descriptionBox">Loading description...</div>
            </div>
        </div>

    <div class="button-container">
    <button class="neumorphic-button" onclick="navigateToMode('flashcard.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
</svg>Flashcard</button>
    <button class="neumorphic-button" onclick="navigateToMode('test.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10.4 12.6-2.8 2.8"></path><path d="m10.4 15.4-2.8-2.8"></path><path d="M12 18h6"></path>
</svg>Test</button>
    <button id="blitzButton" class="neumorphic-button" onclick="navigateToMode('blitz.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
</svg>
    Blitz
    <img src="new.png" alt="New Feature" class="new-icon">
</button>
    <button class="neumorphic-button active" onclick="navigateToMode('learn.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.232 5.232a3 3 0 0 1 0 4.242L12 12.728l-3.232-3.232a3 3 0 0 1 0-4.242a3 3 0 0 1 4.242 0z"></path><path d="M12 12.728 8.768 9.496a3 3 0 0 1 0 4.242L12 17.228l3.232-3.232a3 3 0 0 1 0-4.242z"></path>
</svg>Learn</button>
    <button class="neumorphic-button" onclick="navigateToMode('match.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 7h-4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path><path d="M10 7V5.5a1.5 1.5 0 0 1 3 0V7"></path><path d="M14 17v1.5a1.5 1.5 0 0 1-3 0V17"></path><path d="M7 10H5.5a1.5 1.5 0 0 0 0 3H7"></path><path d="M17 14h1.5a1.5 1.5 0 0 0 0-3H17"></path>
</svg>Match</button>
    <button class="neumorphic-button" onclick="navigateToMode('defidrop.html')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"></path><path d="m19 12-7-7"></path>
</svg>DefiDrop</button>
</div>
<div class="shortcut-bar">
    <i class="fa-solid fa-keyboard"></i>
    <span>Shortcuts: Press</span>
    <kbd class="shortcut-key">Q</kbd>
    <kbd class="shortcut-key">W</kbd>
    <kbd class="shortcut-key">E</kbd>
    <kbd class="shortcut-key">R</kbd>
    <span>to select an answer.</span>
</div>
<button id="exitMistakeReviewBtn" class="neumorphic-button exit-review-btn hidden">
        Exit Mistake Review
    </button>
<div class="definition-row">
        <div class="definition-box" id="learnDefinition">
            Loading definition...
        </div>
        <div class="progress-wrapper" id="progressWrapper">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <div class="choices-container" id="learnChoices">
      </div>

    <div class="navigation-buttons">
    <div class="nav-btn" id="prevBtn">
        <i class="fa-solid fa-shuffle"></i>
    </div>
    <div id="card-counter" class="card-counter">1 / 1</div>
    <div class="nav-btn" id="nextBtn">
        <i class="fa-solid fa-chevron-right"></i>
    </div>
</div>

  </div>
  </main>
<div id="flipTimerModal" class="flip-timer-modal hidden">
  <div class="flip-timer-header">
    <span class="flip-timer-title">üïí FlipTimer</span>
    <span class="flip-timer-close" onclick="closeFlipTimer()">&times;</span>
  </div>
  <div class="flip-timer-body">
    <label for="studyMinutes">Study Minutes:</label>
    <input type="number" id="studyMinutes" min="1" max="180" placeholder="Enter minutes...">
    <h2 id="flipTimerLabel">Ready to Focus?</h2>
    <h1 id="flipTimerClock">00:00</h1>

    <div class="flip-timer-buttons">
      <button onclick="startFlipTimer()">Start</button>
      <button onclick="resetFlipTimer()">Reset</button>
      <button onclick="skipBreak()">Skip</button>
      <button onclick="pauseFlipTimer()" id="pauseButton">‚è∏Ô∏è Pause</button>
    </div>

    <p>Breaks Taken: <span id="breakCounter">0</span></p>
    <div style="text-align: center; margin-top: 10px;">
      <button id="collapseBtn" onclick="collapseFlipTimer()" class="neumorphic-button" style="padding: 4px 12px; font-size: 12px;">‚ñ≤ Collapse</button>
    </div>
  </div>
</div>

<!-- FlipTimer Minimized View -->
<div id="flipTimerMinimized" class="hidden" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 16px;
  border-radius: 16px;
  font-family: 'QilkaBold';
  font-size: 16px;
  z-index: 3000;
  gap: 10px;
  align-items: center;
  box-shadow: 6px 6px 12px rgba(0,0,0,0.3), -6px -6px 12px rgba(255,255,255,0.05);
  cursor: pointer;
  border: 1px solid white;
  backdrop-filter: blur(8px);
  display: flex;
">
<span id="minBreakCounter">0</span>
  <span id="flipTimerMinClock">00:00</span>
   <button onclick="expandFlipTimer()" class="neumorphic-button" style="font-size: 12px; padding: 4px 10px;">‚ñ≤ Expand</button>
</div>

<!-- Confirm Dialog -->
<div id="flipTimerConfirm" class="flip-timer-confirm hidden">
  <div class="flip-timer-confirm-box">
    <p>Want to continue?</p>
    <div>
      <button onclick="confirmFlipTimerContinue(true)">Yes</button>
      <button onclick="confirmFlipTimerContinue(false)">No</button>
    </div>
  </div>
</div>
<div id="reverseInfoModal" class="modal-overlay hidden">
  <div class="modal-box info-modal-content">
    <i class="fa-solid fa-lightbulb modal-info-icon"></i>
    <h3>What is Reverse Mode?</h3>
    <p>Reverse Mode swaps the term and definition. You will be shown the term first and must choose the correct definition from the options.</p>
    <button id="closeReverseInfoModal" class="neumorphic-button">Got it</button>
  </div>
</div>
<div id="mistakesSidenav" class="sidenav right">
        <h3>Learn Mistakes</h3>
        <div class="sidenav-buttons">
            <button id="reviewMistakesBtn" class="sidenav-btn review">
                <i class="fa-solid fa-star"></i> Review
            </button>
            <button id="clearMistakesBtn" class="sidenav-btn reset">
                <i class="fa-solid fa-trash"></i> Clear All
            </button>
        </div>
        <div id="mistakesCardList">
            <p>Loading mistakes...</p>
        </div>
    </div>
    <div id="customConfirmModal" class="custom-alert-backdrop hidden">
  <div class="custom-alert-content error">
    <p id="confirmMessage"></p>
    <div class="modal-buttons">
      <button id="confirmBtn" class="neumorphic-button">Confirm</button>
      <button id="cancelBtn" class="neumorphic-button">Cancel</button>
    </div>
  </div>
</div>

<div id="customAlertModal" class="custom-alert-backdrop hidden">
  <div class="custom-alert-content">
    <p id="customAlertMessage"></p>
    <button id="customAlertOkBtn" class="neumorphic-button">OK</button>
  </div>
</div>
<script src="flipTimer.js"></script>
<script type="module">
    import { db, auth } from './firebaseinit.js';
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // --- Global Variables ---
    let flashcards = [];
    let reverseMode = false;
    let currentIndex = 0;
    let autoAdvanceTimeout = null;
    let currentReviewingSet = null;
    let currentAudio = null;
    let originalFlashcards = []; // Stores the complete, original deck
let localMistakeCards = []; // Local cache of mistake cards
let isMistakeReviewMode = false;

    // --- Element References ---
    const titleElement = document.getElementById("learnSetTitle");
    const defElement = document.getElementById("learnDefinition");
    const choicesContainer = document.getElementById("learnChoices");
    const counterElement = document.getElementById("card-counter");
    const progressWrapper = document.getElementById("progressWrapper");
    const progressBar = document.getElementById("progressBar");
    const reverseToggle = document.getElementById("reverseToggle");
    const reverseInfoBtn = document.getElementById('reverseInfoBtn');
    const reverseInfoModal = document.getElementById('reverseInfoModal');
    const closeReverseInfoModalBtn = document.getElementById('closeReverseInfoModal');
    const mistakesSidenavBtn = document.getElementById('toggleMistakesSidenavBtn');
const mistakesSidenav = document.getElementById('mistakesSidenav');
const mistakesCardList = document.getElementById('mistakesCardList');
const reviewMistakesBtn = document.getElementById('reviewMistakesBtn');
const clearMistakesBtn = document.getElementById('clearMistakesBtn');
const exitMistakeReviewBtn = document.getElementById('exitMistakeReviewBtn');

const descriptionBox = document.getElementById("descriptionBox");
    const cardCategory = document.getElementById("cardCategory");
    const cardCreator = document.getElementById("cardCreator");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const modeButtons = document.querySelectorAll(".button-container .neumorphic-button");


async function playGoogleAudio(textToSpeak) {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }

    const API_KEY = 'AIzaSyCynM5G8GUw3uM8pjdgQkWAsKow3ph9tCg'; // Replace with your actual key

    const apiUrl = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${API_KEY}`;

    const requestBody = {
        input: {
            text: textToSpeak
        },
        voice: {
            languageCode: 'en-US', // Make sure this matches the voice name
            name: 'en-US-WaveNet-G' // Example voice
        },
        audioConfig: {
            audioEncoding: 'MP3'
        }
    };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            console.error('API Error Response:', await response.json());
            throw new Error(`Error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        currentAudio = new Audio(`data:audio/mp3;base64,${data.audioContent}`);
        currentAudio.play();

        currentAudio.onended = () => {
            currentAudio = null;
        };

    } catch (error) {
        console.error('Failed to generate audio. Check console errors (e.g., API key restrictions).', error);
        currentAudio = null;
    }
}

function createSpeakerIcon(textToSpeak) {
    const icon = document.createElement('i');
    icon.className = 'fa-solid fa-volume-high speaker-icon';

    icon.addEventListener('click', (e) => {
        e.stopPropagation();
        playGoogleAudio(textToSpeak);
    });
    return icon;
}


    // This runs when the user's login state is known
    onAuthStateChanged(auth, async (user) => {
        // Logic to show/hide the upgrade button
        if (user && !user.isAnonymous) {
            const upgradeBtn = document.getElementById('upgradeBtn');
            const userRolesRef = doc(db, "approved_emails", user.email);
            const userRolesSnap = await getDoc(userRolesRef);

            if (userRolesSnap.exists()) {
                const roles = userRolesSnap.data().role.toLowerCase();
                if (!roles.includes('plus') && !roles.includes('verified')) {
                    upgradeBtn.style.display = 'inline-block';
                }
            }
        }

        // Logic to load the flashcard set
        const reviewingSetId = localStorage.getItem("reviewingSetId");
        const collectionName = localStorage.getItem("reviewingSetCollection");

        if (!reviewingSetId || !collectionName) {
            // ‚ñº‚ñº‚ñº REPLACED BLOCK ‚ñº‚ñº‚ñº
            console.warn("No reviewingSetId or collectionName found. Displaying placeholder state.");
            
            titleElement.textContent = "No Set Loaded";
            defElement.textContent = "Please select a set from the lobby to begin.";
            descriptionBox.textContent = "Please return to the lobby and select a flashcard set.";
            choicesContainer.innerHTML = "";
            cardCategory.textContent = "-";
            cardCreator.textContent = "-";
            counterElement.textContent = "0 / 0";

            [prevBtn, nextBtn].forEach(btn => {
                btn.style.opacity = "0.5";
                btn.style.pointerEvents = "none";
            });

            modeButtons.forEach(button => {
                button.style.opacity = "0.6";
                button.style.cursor = "not-allowed";
                button.classList.remove('active');
            });
            
            reverseToggle.disabled = true;
            if (mistakesSidenavBtn) mistakesSidenavBtn.style.display = 'none'; // Hide the button
            
            return; // Stop execution
            // ‚ñ≤‚ñ≤‚ñ≤ END OF REPLACED BLOCK ‚ñ≤‚ñ≤‚ñ≤
        }

        try {
            const setRef = doc(db, collectionName, reviewingSetId);
            const docSnap = await getDoc(setRef);

            if (docSnap.exists()) {
                currentReviewingSet = docSnap.data();
                flashcards = currentReviewingSet.flashcards || [];
                
                // ‚ñº‚ñº‚ñº ADD THIS ‚ñº‚ñº‚ñº
                // Store the original deck and give each card its original index
                originalFlashcards = [...flashcards];
                originalFlashcards.forEach((card, index) => card.originalIndex = index);
                // ‚ñ≤‚ñ≤‚ñ≤ END OF ADDITION ‚ñ≤‚ñ≤‚ñ≤

                populatePageInfo(currentReviewingSet);

                // ‚ñº‚ñº‚ñº ADD THIS ‚ñº‚ñº‚ñº
                setupMistakeListener(user); // Set up the real-time listener for mistakes
                // ‚ñ≤‚ñ≤‚ñ≤ END OF ADDITION ‚ñ≤‚ñ≤‚ñ≤

                if (flashcards.length < 4) {
                    defElement.textContent = "You need at least 4 cards in a set to use Learn Mode.";
                    choicesContainer.innerHTML = "";
                    return;
                }
                
                updateCard(currentIndex);

            } else {
                // ‚ñº‚ñº‚ñº REPLACED BLOCK ‚ñº‚ñº‚ñº
                console.error("Set ID found, but document does not exist.");
                titleElement.textContent = "Error: Set Not Found";
                defElement.textContent = "The requested set could not be found in the database.";
                descriptionBox.textContent = "Please return to the lobby and select a flashcard set.";
                choicesContainer.innerHTML = "";
                cardCategory.textContent = "-";
                cardCreator.textContent = "-";
                counterElement.textContent = "0 / 0";
                [prevBtn, nextBtn].forEach(btn => {
                    btn.style.opacity = "0.5";
                    btn.style.pointerEvents = "none";
                });
                modeButtons.forEach(button => {
                    button.style.opacity = "0.6";
                    button.style.cursor = "not-allowed";
                    button.classList.remove('active');
                });
                reverseToggle.disabled = true;
                if (mistakesSidenavBtn) mistakesSidenavBtn.style.display = 'none';
                // ‚ñ≤‚ñ≤‚ñ≤ END OF REPLACED BLOCK ‚ñ≤‚ñ≤‚ñ≤
            }
        } catch (error) {
            console.error("Error loading set:", error);
            // ‚ñº‚ñº‚ñº REPLACED BLOCK ‚ñº‚ñº‚ñº
            titleElement.textContent = "Error Loading Set";
            defElement.textContent = "An error occurred while loading. Please try again.";
            descriptionBox.textContent = "An error occurred. Please return to the lobby.";
            choicesContainer.innerHTML = "";
            cardCategory.textContent = "-";
            cardCreator.textContent = "-";
            counterElement.textContent = "0 / 0";
            [prevBtn, nextBtn].forEach(btn => {
                btn.style.opacity = "0.5";
                btn.style.pointerEvents = "none";
            });
            modeButtons.forEach(button => {
                button.style.opacity = "0.6";
                button.style.cursor = "not-allowed";
                button.classList.remove('active');
            });
            reverseToggle.disabled = true;
            if (mistakesSidenavBtn) mistakesSidenavBtn.style.display = 'none';
            // ‚ñ≤‚ñ≤‚ñ≤ END OF REPLACED BLOCK ‚ñ≤‚ñ≤‚ñ≤
        }
    });

    async function populatePageInfo(setData) {
        document.getElementById("learnSetTitle").textContent = setData.title || "Untitled Set";
        document.getElementById("descriptionBox").textContent = setData.description || "No description provided.";
        document.getElementById("cardCategory").textContent = setData.category || "General";
        const creatorEmail = setData.creatorEmail || setData.user;
        if (creatorEmail) {
            const usernameRef = doc(db, "usernames", creatorEmail);
            const usernameSnap = await getDoc(usernameRef);
            document.getElementById("cardCreator").textContent = usernameSnap.exists() && usernameSnap.data().username 
                ? usernameSnap.data().username 
                : creatorEmail.split('@')[0];
        } else {
            document.getElementById("cardCreator").textContent = "N/A";
        }
    }
    function showCustomConfirm(message, onConfirm) {
        const confirmModal = document.getElementById('customConfirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        confirmMessage.textContent = message;
        confirmModal.classList.remove('hidden');

        const confirmHandler = () => {
            onConfirm();
            closeHandler();
        };

        const closeHandler = () => {
            confirmModal.classList.add('hidden');
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', closeHandler);
        };

        confirmBtn.addEventListener('click', confirmHandler, { once: true });
        cancelBtn.addEventListener('click', closeHandler, { once: true });
    }

    function showCustomAlert(message) {
        const alertModal = document.getElementById('customAlertModal');
        const alertMessage = document.getElementById('customAlertMessage');
        const alertOkBtn = document.getElementById('customAlertOkBtn');

        alertMessage.textContent = message;
        alertModal.classList.remove('hidden');

        const closeHandler = () => {
            alertModal.classList.add('hidden');
            alertOkBtn.removeEventListener('click', closeHandler);
        };

        alertOkBtn.addEventListener('click', closeHandler, { once: true });
    }
    // --- All original Learn Mode functions remain below ---

    function showProgressBar(duration = 3000) {
        if (!progressWrapper || !progressBar) return;
        progressWrapper.style.display = "block";
        progressBar.style.transition = "none";
        progressBar.style.width = "0%";
        setTimeout(() => {
            progressBar.style.transition = `width ${duration}ms linear`;
            progressBar.style.width = "100%";
        }, 50);
    }

    function resetProgressBar() {
        if (!progressWrapper || !progressBar) return;
        progressWrapper.style.display = "none";
        progressBar.style.width = "0%";
        progressBar.style.transition = "none";
    }

    function isImageUrl(text) {
        return typeof text === "string" && text.startsWith("https://") && text.includes("firebasestorage.googleapis.com");
    }

  function updateCard(index) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }

        clearTimeout(autoAdvanceTimeout);
        resetProgressBar();
        const currentCard = flashcards[index];

        const oldIcon = defElement.querySelector('.speaker-icon');
        if (oldIcon) oldIcon.remove();

        // ‚ñº‚ñº‚ñº REVERSE MODE LOGIC ‚ñº‚ñº‚ñº
        const mainContent = reverseMode ? currentCard.term : currentCard.definition;
        const correctChoice = reverseMode ? currentCard.definition : currentCard.term;
        const allChoices = reverseMode
            ? flashcards.map(fc => fc.definition)
            : flashcards.map(fc => fc.term);
        // ‚ñ≤‚ñ≤‚ñ≤ END OF REVERSE MODE LOGIC ‚ñ≤‚ñ≤‚ñ≤

        const mainContentIsImage = isImageUrl(mainContent);
        if (mainContentIsImage) {
            defElement.innerHTML = `<img src="${mainContent}" alt="Main Content Image" />`;
        } else {
            defElement.textContent = mainContent;
            defElement.appendChild(createSpeakerIcon(mainContent));
        }

        let choices = allChoices.filter(choice => choice !== correctChoice);
        choices = choices.sort(() => 0.5 - Math.random()).slice(0, 3);
        choices.push(correctChoice);
        choices = choices.sort(() => 0.5 - Math.random());

        const labels = ['A', 'B', 'C', 'D'];
        choicesContainer.innerHTML = choices.map((opt, i) =>
            `<div class="choice" data-choice="${opt}">${labels[i]}. ${opt}</div>` // Changed data-term to data-choice
        ).join('');
        counterElement.textContent = `${index + 1} / ${flashcards.length}`;

        document.querySelectorAll('.choice').forEach(choice => {
            choice.addEventListener('click', function handleChoice() {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                const selectedChoice = this.getAttribute('data-choice'); // Changed to data-choice
                const isCorrect = selectedChoice === correctChoice;
                document.querySelectorAll('.choice').forEach(c => {
                    c.classList.add('disabled');
                    // Check if the choice attribute matches the correct choice
                    if (c.getAttribute('data-choice') === correctChoice) c.style.backgroundColor = '#228B22';
                });

                if (!isCorrect) {
                    this.style.backgroundColor = '#B22222';
                    // ‚ñº‚ñº‚ñº ADD THIS ‚ñº‚ñº‚ñº
                    // Record the mistake, but don't wait for it to finish
                    recordMistake(flashcards[currentIndex]);
                    // ‚ñ≤‚ñ≤‚ñ≤ END OF ADDITION ‚ñ≤‚ñ≤‚ñ≤
                } else {
                    // ‚ñº‚ñº‚ñº ADD THIS ‚ñº‚ñº‚ñº
                    // If we're in review mode and got it right, remove it
                    if (isMistakeReviewMode) {
                        removeMistake(flashcards[currentIndex]);
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ END OF ADDITION ‚ñ≤‚ñ≤‚ñ≤
                }

                showProgressBar(3000);
                autoAdvanceTimeout = setTimeout(() => { goToCard(1); }, 3000);
            }, { once: true });
        });
    } 
function goToCard(direction) {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }

    clearTimeout(autoAdvanceTimeout);
    resetProgressBar();
    currentIndex = (currentIndex + direction + flashcards.length) % flashcards.length;
    updateCard(currentIndex);
}

    document.getElementById("nextBtn").addEventListener("click", () => goToCard(1));
    function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]]; // Swap elements
  }
}

document.getElementById("prevBtn").addEventListener("click", () => {
    clearTimeout(autoAdvanceTimeout);
    resetProgressBar();

    // --- NEW: Shuffle the flashcards array ---
    shuffleArray(flashcards);

    currentIndex = 0; // Reset to the new first card
    updateCard(currentIndex);
});
    
    // --- Functions for other mode buttons ---
    function navigateToMode(modeUrl) {
        if (currentReviewingSet) {
            localStorage.setItem("reviewingSet", JSON.stringify(currentReviewingSet));
        }
        localStorage.setItem("currentIndex", currentIndex);
        window.location.href = modeUrl;
    }
   window.navigateToMode = navigateToMode; // <<< --- ADD THIS LINE ---
    document.addEventListener("keydown", (event) => {
        // Do nothing if the user is typing in an input field
        if (document.activeElement.tagName === "INPUT") return;
        
        const choices = document.querySelectorAll('.choice');
        // Do nothing if there are no choices or if they are already disabled
        if (choices.length === 0 || choices[0].classList.contains('disabled')) return;

        // Prevent default browser actions for these keys
        event.preventDefault();

        switch (event.key.toLowerCase()) {
          case 'q':
            choices[0]?.click();
            break;
          case 'w':
            choices[1]?.click();
            break;
          case 'e':
            choices[2]?.click();
            break;
          case 'r':
            choices[3]?.click();
            break;
        }
      });
      reverseToggle.addEventListener("change", (event) => { 
        reverseMode = event.target.checked; 
        updateCard(currentIndex); // Re-load the current card
    });

    reverseInfoBtn.addEventListener('click', () => {
      reverseInfoModal.classList.remove('hidden');
    });

    closeReverseInfoModalBtn.addEventListener('click', () => {
      reverseInfoModal.classList.add('hidden');
    });

    reverseInfoModal.addEventListener('click', (event) => {
      if (event.target === reverseInfoModal) {
        reverseInfoModal.classList.add('hidden');
      }
    });
    function setupMistakeListener(user) {
        if (!user || user.isAnonymous) {
            mistakesCardList.innerHTML = "<p>Please log in to see your mistakes.</p>";
            return;
        }

        const mistakeRef = doc(db, "learnmistake", user.email);
        onSnapshot(mistakeRef, (docSnap) => {
            const cards = (docSnap.exists() && docSnap.data().mistakes) ? docSnap.data().mistakes : [];
            localMistakeCards = cards;
            updateMistakesSidenav(cards);
        }, (error) => {
            console.error("Error with mistake listener:", error);
            mistakesCardList.innerHTML = "<p>Error loading mistakes.</p>";
        });
    }

    function updateMistakesSidenav(cards) {
        if (cards.length === 0) {
            mistakesCardList.innerHTML = "<p>You haven't made any mistakes yet. Keep it up!</p>";
            return;
        }

        mistakesCardList.innerHTML = ""; // Clear list
        cards.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'mistake-card-item';
            cardElement.innerHTML = `
                <p class="term">${card.term}</p>
                <p class="definition">${card.definition}</p>
            `;
            mistakesCardList.appendChild(cardElement);
        });
    }

    async function recordMistake(card) {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return;

        const cardData = { term: card.term, definition: card.definition };

        // Check local cache first to prevent duplicate writes
        const isAlreadySaved = localMistakeCards.some(
            c => c.term === cardData.term && c.definition === cardData.definition
        );
        if (isAlreadySaved) return;

        const mistakeRef = doc(db, "learnmistake", user.email);
        try {
            await setDoc(mistakeRef, {
                mistakes: arrayUnion(cardData)
            }, { merge: true });
        } catch (error) {
            console.error("Error recording mistake:", error);
        }
    }

    async function removeMistake(card) {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return;

        const cardData = { term: card.term, definition: card.definition };
        const mistakeRef = doc(db, "learnmistake", user.email);
        try {
            await updateDoc(mistakeRef, {
                mistakes: arrayRemove(cardData)
            });
        } catch (error) {
            console.error("Error removing mistake:", error);
        }
    }

    // --- Sidenav Button Event Listeners ---

    mistakesSidenavBtn.addEventListener('click', () => {
        const currentWidth = mistakesSidenav.style.width;
        const keyIcon = mistakesSidenavBtn.querySelector('i');
        if (currentWidth === "350px") {
            mistakesSidenav.style.width = "0";
            mistakesSidenavBtn.style.right = "0";
            
        } else {
            mistakesSidenav.style.width = "350px";
            mistakesSidenavBtn.style.right = "350px";
            
        }
    });

    clearMistakesBtn.addEventListener('click', () => {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) return showCustomAlert("Please log in.");

        showCustomConfirm("Are you sure you want to clear ALL your recorded mistakes for this mode? This cannot be undone.", () => {
            const mistakeRef = doc(db, "learnmistake", user.email);
            setDoc(mistakeRef, { mistakes: [] }, { merge: true })
                .catch(err => console.error("Error clearing mistakes:", err));
        }); // <-- 1. ADDED the missing closing parenthesis here
    //  <-- 2. REMOVED the extra '});' from this line
    });

    reviewMistakesBtn.addEventListener('click', () => {
        if (localMistakeCards.length === 0) {
            return showCustomAlert("You have no mistakes to review!");
        }
        if (localMistakeCards.length < 4) {
            return showCustomAlert(`Learn Mode requires at least 4 cards. You only have ${localMistakeCards.length} mistake(s).`);
        }

        isMistakeReviewMode = true;
        flashcards = [...localMistakeCards]; // Set the main deck to only mistake cards
        shuffleArray(flashcards); // Shuffle the mistake deck
        currentIndex = 0;

        // Update UI for review mode
        titleElement.textContent = "Mistake Review Session";
        descriptionBox.textContent = "Reviewing cards you got wrong.";
        exitMistakeReviewBtn.classList.remove('hidden');
        reverseToggle.disabled = true; // Lock the toggle

        updateCard(currentIndex); // Load the first mistake
        
        // Close sidenav
        mistakesSidenav.style.width = "0";
        mistakesSidenavBtn.style.right = "0";
    });

    exitMistakeReviewBtn.addEventListener('click', () => {
        isMistakeReviewMode = false;
        flashcards = [...originalFlashcards]; // Restore the original full deck
        currentIndex = 0; // Reset to start

        // Restore UI
        populatePageInfo(currentReviewingSet); // Restore original title, desc, etc.
        exitMistakeReviewBtn.classList.add('hidden');
        reverseToggle.disabled = false; // Re-enable toggle

        updateCard(currentIndex); // Load first card of original deck
    });
</script>

<script>
  function goToFlashcard() {
    window.location.href = "flashcard.html";
  }
</script>

<script>
  document.querySelectorAll(".hover-switch").forEach(img => {
    const def = img.getAttribute("data-default");
    const hov = img.getAttribute("data-hover");
    img.addEventListener("mouseover", () => img.src = hov);
    img.addEventListener("mouseout", () => img.src = def);
  });
</script>
<script>
  function goToTest() {
    localStorage.setItem("currentIndex", currentIndex); // Save current index
    window.location.href = "test.html";
  }
</script>
<script>
document.addEventListener("keydown", function (e) {
  if (document.activeElement.tagName !== "INPUT") {
    if (e.key === "ArrowRight") {
      goToCard(1); // next
    } else if (e.key === "ArrowLeft") {
      goToCard(-1); // previous
    }
  }
});

</script>
<script>
  function goToMatch() {
    localStorage.setItem("currentIndex", currentIndex); // optional if you want to track card index
    window.location.href = "match.html";
  }
  function goToDefidrop() {
    localStorage.setItem("currentIndex", 0);
    window.location.href = "defidrop.html";
  }
</script>
<script type="module">
  import { checkUserStatus } from './userstatuscheck.js';
  checkUserStatus();
</script>
<script type="module" src="presence.js"></script>
<script src="protect.js"></script>
<script type="module" src="xpTracker.js"></script>
</body>
</html>
